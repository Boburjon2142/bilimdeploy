{% extends "base.html" %}
{% block content %}
<div class="px-3 py-3">
  <h4 class="fw-bold mb-3">Tasdiqlash kodi</h4>
  <div class="text-muted small mb-3">Kod Telegram botdan yuborildi: {{ phone }}</div>
  <div class="card border-0 shadow-sm p-3 mb-3" style="border-radius:16px;">
    <div class="mb-2 fw-semibold">Telegramga yuborish</div>
    <div class="text-muted small mb-3">Quyidagi buyruqni botga yuboring yoki tugma orqali oching.</div>
    <div class="d-flex flex-wrap gap-2 align-items-stretch">
      <input id="tg-start-command" class="form-control" type="text" readonly value="{{ start_command }}" style="flex:1 1 220px;">
      <button class="btn btn-outline-secondary" type="button" id="tg-copy-btn">Nusxa olish</button>
      {% if needs_link and telegram_bot_username %}
      <a
        id="tg-start-link"
        class="btn btn-outline-secondary"
        target="_blank"
        rel="noopener"
        href="https://t.me/{{ telegram_bot_username }}?start={{ phone_clean|urlencode }}"
        data-app="tg://resolve?domain={{ telegram_bot_username }}&start={{ phone_clean|urlencode }}"
      >Botga oâ€˜tish</a>
      {% endif %}
    </div>
  </div>
  <form method="post" class="card border-0 shadow-sm p-3" style="border-radius:16px;">
    {% csrf_token %}
    {% if form.non_field_errors %}
    <div class="alert alert-danger py-2">
      {% for err in form.non_field_errors %}<div>{{ err }}</div>{% endfor %}
    </div>
    {% endif %}
    <div class="mb-3">
      <label class="form-label">Tasdiqlash kodi</label>
      {{ form.code }}
      {% if form.code.errors %}<div class="text-danger small">{{ form.code.errors|striptags }}</div>{% endif %}
    </div>
    <button class="btn btn-primary w-100" type="submit">Tasdiqlash</button>
  </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
  (function () {
    const link = document.getElementById("tg-start-link");
    if (link) {
      const appLink = link.getAttribute("data-app");
      link.addEventListener("click", function () {
        if (!appLink) return;
        const fallback = link.getAttribute("href");
        window.location.href = appLink;
        setTimeout(function () {
          if (fallback) window.location.href = fallback;
        }, 900);
      });
    }
    const copyBtn = document.getElementById("tg-copy-btn");
    const input = document.getElementById("tg-start-command");
    if (copyBtn && input) {
      copyBtn.addEventListener("click", function () {
        const text = input.value;
        const done = function () {
          copyBtn.textContent = "Nusxa olindi";
          setTimeout(function () {
            copyBtn.textContent = "Nusxa olish";
          }, 1200);
        };
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(text).then(done).catch(function () {
            input.select();
            input.setSelectionRange(0, text.length);
            document.execCommand("copy");
            done();
          });
        } else {
          input.select();
          input.setSelectionRange(0, text.length);
          document.execCommand("copy");
          done();
        }
      });
    }
  })();
</script>
{% endblock %}
